---
export interface Props {
  maquinas?: Array<any>;
  categorias?: Array<any>;
  subcategorias?: Array<any>;
  initialFilters?: {
    servicios?: string[];
    categoria?: string;
    subcategoria?: string;
    searchTerm?: string;
  };
  compact?: boolean;
}

const { 
  maquinas = [], 
  categorias = [], 
  subcategorias = [],
  initialFilters = {},
  compact = false 
} = Astro.props;

// Extraer valores únicos para filtros
const getUniqueServicios = () => {
  const servicios = new Set<string>();
  maquinas.forEach(maquina => {
    if (maquina.servicios) {
      Object.keys(maquina.servicios).forEach(servicio => {
        if (maquina.servicios[servicio]) {
          servicios.add(servicio);
        }
      });
    }
  });
  return Array.from(servicios);
};

const getUniqueCategorias = () => {
  const categoriasUnicas = new Set<string>();
  maquinas.forEach(maquina => {
    if (maquina.categoriaId) {
      categoriasUnicas.add(maquina.categoriaId);
    }
  });
  return Array.from(categoriasUnicas);
};

const getUniqueSubcategorias = () => {
  const subcategoriasUnicas = new Set<string>();
  maquinas.forEach(maquina => {
    if (maquina.subcategoriaId) {
      subcategoriasUnicas.add(maquina.subcategoriaId);
    }
  });
  return Array.from(subcategoriasUnicas);
};
---

<div class={`filtros-maquinaria ${compact ? 'compact' : ''}`}>
  <div class="filtros-header">
    <h3 class="filtros-titulo">Filtros</h3>
    <button class="btn-limpiar" onclick="limpiarTodosLosFiltros()">Limpiar</button>
  </div>

  <div class="filtros-container">
    {/* Búsqueda */}
    <div class="filtro-grupo">
      <label class="filtro-label" for="busqueda">Buscar</label>
      <input 
        type="text" 
        id="busqueda" 
        class="filtro-input"
        placeholder="Buscar por nombre..."
        oninput="aplicarFiltros()"
        value={initialFilters.searchTerm || ''}
      />
    </div>

    {/* Categorías */}
    {!compact && categorias.length > 0 && (
      <div class="filtro-grupo">
        <label class="filtro-label">Categoría</label>
        <div class="filtro-checkboxes">
          {categorias.map(categoria => (
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                value={categoria.id}
                onchange="aplicarFiltros()"
                checked={initialFilters.categoria === categoria.id}
              />
              <span class="checkbox-text">{categoria.nombre}</span>
            </label>
          ))}
        </div>
      </div>
    )}

    {/* Subcategorías */}
    {!compact && subcategorias.length > 0 && (
      <div class="filtro-grupo">
        <label class="filtro-label">Subcategoría</label>
        <select 
          class="filtro-select"
          onchange="aplicarFiltros()"
        >
          <option value="">Todas</option>
          {subcategorias.map(subcat => (
            <option 
              value={subcat.id}
              selected={initialFilters.subcategoria === subcat.id}
            >
              {subcat.nombre}
            </option>
          ))}
        </select>
      </div>
    )}

    {/* Servicios */}
    <div class="filtro-grupo">
      <label class="filtro-label">Servicios</label>
      <div class="filtro-checkboxes">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            value="alquiler"
            onchange="aplicarFiltros()"
            checked={initialFilters.servicios?.includes('alquiler')}
          />
          <span class="checkbox-text">Alquiler</span>
        </label>
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            value="venta"
            onchange="aplicarFiltros()"
            checked={initialFilters.servicios?.includes('venta')}
          />
          <span class="checkbox-text">Venta</span>
        </label>
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            value="reparacion"
            onchange="aplicarFiltros()"
            checked={initialFilters.servicios?.includes('reparacion')}
          />
          <span class="checkbox-text">Reparación</span>
        </label>
      </div>
    </div>

    {/* Vista */}
    <div class="filtro-grupo">
      <label class="filtro-label">Vista</label>
      <div class="vista-toggle">
        <button 
          class="vista-btn grid active" 
          onclick="setVista('grid')"
          title="Vista en cuadrícula"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <rect x="1" y="1" width="6" height="6" />
            <rect x="9" y="1" width="6" height="6" />
            <rect x="1" y="9" width="6" height="6" />
            <rect x="9" y="9" width="6" height="6" />
          </svg>
        </button>
        <button 
          class="vista-btn list" 
          onclick="setVista('list')"
          title="Vista en lista"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <rect x="1" y="2" width="14" height="2" />
            <rect x="1" y="7" width="14" height="2" />
            <rect x="1" y="12" width="14" height="2" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  {/* Resultados */}
  <div class="filtros-resultado">
    <span class="resultados-count">
      <span id="count-resultados">0</span> máquinas encontradas
    </span>
  </div>
</div>

<script>
  // Variables globales para los filtros
  let maquinasData = [];
  let vistaActual = 'grid';

  // Inicializar filtros cuando se carga el componente
  document.addEventListener('DOMContentLoaded', function() {
    // Intentar obtener datos del dataset o del global
    const maquinasElement = document.querySelector('[data-maquinas]');
    if (maquinasElement) {
      try {
        maquinasData = JSON.parse(maquinasElement.dataset.maquinas);
      } catch (e) {
        console.error('Error parsing maquinas data:', e);
      }
    }
    
    aplicarFiltros();
  });

  function aplicarFiltros() {
    if (!maquinasData.length) return;

    const searchTerm = document.getElementById('busqueda')?.value.toLowerCase() || '';
    const categoriasSeleccionadas = Array.from(document.querySelectorAll('input[type="checkbox"][value^="aire-"], input[type="checkbox"][value^="limpieza"], input[type="checkbox"][value^="demolicion"]:checked'))
      .map(cb => cb.value);
    const subcategoriaSeleccionada = document.querySelector('.filtro-select')?.value || '';
    const serviciosSeleccionados = Array.from(document.querySelectorAll('input[type="checkbox"][value="alquiler"]:checked, input[type="checkbox"][value="venta"]:checked, input[type="checkbox"][value="reparacion"]:checked'))
      .map(cb => cb.value);

    let resultados = maquinasData.filter(maquina => {
      // Filtro por búsqueda
      if (searchTerm && !maquina.nombre.toLowerCase().includes(searchTerm)) {
        return false;
      }

      // Filtro por categorías
      if (categoriasSeleccionadas.length > 0 && !categoriasSeleccionadas.includes(maquina.categoriaId)) {
        return false;
      }

      // Filtro por subcategoría
      if (subcategoriaSeleccionada && maquina.subcategoriaId !== subcategoriaSeleccionada) {
        return false;
      }

      // Filtro por servicios
      if (serviciosSeleccionados.length > 0) {
        const tieneServicio = serviciosSeleccionados.some(servicio => 
          maquina.servicios && maquina.servicios[servicio]
        );
        if (!tieneServicio) return false;
      }

      return true;
    });

    actualizarResultados(resultados);
  }

  function actualizarResultados(resultados) {
    const countElement = document.getElementById('count-resultados');
    if (countElement) {
      countElement.textContent = resultados.length;
    }

    // Emitir evento personalizado para que los componentes padres actualicen la vista
    const event = new CustomEvent('filtrosActualizados', {
      detail: { resultados, vista: vistaActual }
    });
    document.dispatchEvent(event);
  }

  function setVista(vista) {
    vistaActual = vista;
    
    // Actualizar botones
    document.querySelectorAll('.vista-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`.vista-btn.${vista}`).classList.add('active');

    // Actualizar vista de las tarjetas
    document.querySelectorAll('.maquina-card').forEach(card => {
      card.classList.remove('grid', 'list');
      card.classList.add(vista);
    });

    // Re-aplicar filtros para actualizar la vista
    aplicarFiltros();
  }

  function limpiarTodosLosFiltros() {
    // Limpiar búsqueda
    const busquedaInput = document.getElementById('busqueda');
    if (busquedaInput) busquedaInput.value = '';

    // Limpiar checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.checked = false;
    });

    // Limpiar select
    const select = document.querySelector('.filtro-select');
    if (select) select.value = '';

    aplicarFiltros();
  }

  // Hacer funciones disponibles globalmente
  window.aplicarFiltros = aplicarFiltros;
  window.setVista = setVista;
  window.limpiarTodosLosFiltros = limpiarTodosLosFiltros;
</script>

<style>
  .filtros-maquinaria {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(21, 104, 167, 0.1);
    position: sticky;
    top: 2rem;
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
  }

  .filtros-maquinaria.compact {
    padding: 1rem;
    position: relative;
    max-height: none;
  }

  /* Header */
  .filtros-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(21, 104, 167, 0.1);
  }

  .filtros-titulo {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #1568a7;
  }

  .btn-limpiar {
    background: transparent;
    border: 1px solid #ddd;
    color: #666;
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-limpiar:hover {
    background: #f8f9fa;
    border-color: #1568a7;
    color: #1568a7;
  }

  /* Container */
  .filtros-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Grupo de filtro */
  .filtro-grupo {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .filtro-label {
    font-weight: 600;
    color: #333;
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
  }

  .filtro-input,
  .filtro-select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: border-color 0.3s ease;
  }

  .filtro-input:focus,
  .filtro-select:focus {
    outline: none;
    border-color: #1568a7;
    box-shadow: 0 0 0 2px rgba(21, 104, 167, 0.1);
  }

  /* Checkboxes */
  .filtro-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }

  .checkbox-label:hover {
    background: rgba(21, 104, 167, 0.05);
  }

  .checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #1568a7;
  }

  .checkbox-text {
    font-size: 0.9rem;
    color: #555;
  }

  /* Vista Toggle */
  .vista-toggle {
    display: flex;
    gap: 0.3rem;
  }

  .vista-btn {
    padding: 0.4rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .vista-btn:hover {
    background: #f8f9fa;
  }

  .vista-btn.active {
    background: #1568a7;
    border-color: #1568a7;
    color: white;
  }

  .vista-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Resultados */
  .filtros-resultado {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(21, 104, 167, 0.1);
    text-align: center;
  }

  .resultados-count {
    font-size: 0.9rem;
    color: #666;
    font-weight: 500;
  }

  #count-resultados {
    color: #1568a7;
    font-weight: 600;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .filtros-maquinaria {
      position: relative;
      top: 0;
      max-height: none;
    }
  }

  @media (max-width: 768px) {
    .filtros-maquinaria {
      padding: 1rem;
    }

    .filtros-header {
      flex-direction: column;
      align-items: stretch;
      gap: 0.5rem;
    }

    .filtro-checkboxes {
      flex-direction: row;
      flex-wrap: wrap;
    }

    .checkbox-label {
      flex: 1;
      min-width: 120px;
    }
  }
</style>